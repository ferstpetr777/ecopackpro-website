<?php
/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ
 * Ð¦ÐµÐ»ÑŒ: Ð’Ñ‹Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð²ÑÐµ 193 Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð²Ð¼ÐµÑÑ‚Ð¾ 76
 */

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº WordPress
require_once('/var/www/fastuser/data/www/ecopackpro.ru/wp-config.php');
require_once('/var/www/fastuser/data/www/ecopackpro.ru/wp-load.php');

echo "=== Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð’Ð«Ð“Ð Ð£Ð—ÐšÐ˜ Ð¢ÐžÐ’ÐÐ ÐžÐ’ Ð’ Ð’ÐšÐžÐÐ¢ÐÐšÐ¢Ð• ===\n\n";

// 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
global $wpdb;

echo "1. ÐÐÐÐ›Ð˜Ð— Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð¯:\n";
echo "================================\n";

// ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
$total_products = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->posts} WHERE post_type = 'product' AND post_status = 'publish'");
echo "Ð’ÑÐµÐ³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…: {$total_products}\n";

// ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
$exported_products = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->postmeta} WHERE meta_key = '_ip2vk_prod_id_on_vk'");
echo "Ð’Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð² Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ: {$exported_products}\n";

$not_exported = $total_products - $exported_products;
echo "ÐÐ• Ð²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾: {$not_exported}\n\n";

// 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°
echo "2. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐÐÐ¡Ð¢Ð ÐžÐ•Ðš ÐŸÐ›ÐÐ“Ð˜ÐÐ:\n";
echo "==============================\n";

$settings = get_option('ip2vk_settings_arr');
if ($settings && isset($settings[1])) {
    $group_settings = $settings[1];
    
    echo "ID Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ: " . ($group_settings['group_id'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') . "\n";
    echo "Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: " . ($group_settings['syncing_with_vk'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°') . "\n";
    echo "Ð¨Ð°Ð³ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: " . ($group_settings['step_export'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') . "\n";
    echo "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸: " . ($group_settings['status_sborki'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') . "\n";
    echo "ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ñ„Ð¸Ð´Ðµ: " . ($group_settings['count_products_in_feed'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾') . "\n";
    echo "CRON ÑÑ‚Ð°Ñ‚ÑƒÑ: " . ($group_settings['status_cron'] ?? 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') . "\n\n";
}

// 3. Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸
echo "3. Ð¡Ð‘Ð ÐžÐ¡ Ð¡Ð¢ÐÐ¢Ð£Ð¡Ð Ð”Ð›Ð¯ ÐŸÐžÐ›ÐÐžÐ™ ÐŸÐ•Ð Ð•Ð’Ð«Ð“Ð Ð£Ð—ÐšÐ˜:\n";
echo "==========================================\n";

if ($settings && isset($settings[1])) {
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸
    $settings[1]['status_sborki'] = '1'; // 1 = Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÑƒ
    $settings[1]['date_sborki'] = time();
    $settings[1]['date_sborki_end'] = '0000000001';
    $settings[1]['count_products_in_feed'] = '-1'; // -1 = Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹
    $settings[1]['status_cron'] = 'enabled'; // Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ CRON
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
    update_option('ip2vk_settings_arr', $settings);
    echo "âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½\n";
    echo "âœ… Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: " . date('Y-m-d H:i:s') . "\n";
    echo "âœ… CRON Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½\n";
    echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð²Ñ‹Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹\n\n";
}

// 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð±ÐµÐ· Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸
echo "4. ÐÐÐÐ›Ð˜Ð— ÐÐ•Ð’Ð«Ð“Ð Ð£Ð–Ð•ÐÐÐ«Ð¥ Ð¢ÐžÐ’ÐÐ ÐžÐ’:\n";
echo "=================================\n";

$not_exported_query = "
    SELECT p.ID, p.post_title, p.post_status 
    FROM {$wpdb->posts} p 
    LEFT JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id AND pm.meta_key = '_ip2vk_prod_id_on_vk'
    WHERE p.post_type = 'product' 
    AND p.post_status = 'publish'
    AND pm.meta_value IS NULL
    LIMIT 10
";

$not_exported_products = $wpdb->get_results($not_exported_query);

echo "ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð½ÐµÐ²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²:\n";
foreach ($not_exported_products as $product) {
    echo "- ID: {$product->ID}, ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: {$product->post_title}\n";
}

if (count($not_exported_products) > 10) {
    echo "... Ð¸ ÐµÑ‰Ðµ " . ($not_exported - 10) . " Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²\n";
}

echo "\n";

// 5. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸
echo "5. Ð—ÐÐŸÐ£Ð¡Ðš ÐŸÐ ÐžÐ¦Ð•Ð¡Ð¡Ð Ð’Ð«Ð“Ð Ð£Ð—ÐšÐ˜:\n";
echo "=============================\n";

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð»Ð¸ Ð¿Ð»Ð°Ð³Ð¸Ð½
if (!function_exists('ip2vk_do_this_event')) {
    echo "âŒ ÐŸÐ»Ð°Ð³Ð¸Ð½ Import Products to VK Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð¸Ð»Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°\n";
    exit;
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÑƒ
echo "ðŸ”„ Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÑƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²...\n";

// Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
if (function_exists('ip2vk_do_this_event')) {
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸
    wp_schedule_single_event(time(), 'ip2vk_do_this_event');
    echo "âœ… Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾\n";
}

// 6. Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸
echo "\n6. Ð”ÐžÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐ«Ð• ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜:\n";
echo "==============================\n";

// Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
ini_set('memory_limit', '512M');
set_time_limit(0);

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ„Ð°Ð¹Ð»Ð°Ð¼
$upload_dir = wp_upload_dir();
$vk_upload_dir = $upload_dir['basedir'] . '/import-products-to-vk/';

if (!is_dir($vk_upload_dir)) {
    wp_mkdir_p($vk_upload_dir);
    echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ\n";
}

if (is_writable($vk_upload_dir)) {
    echo "âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸\n";
} else {
    echo "âš ï¸ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸\n";
}

// 7. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
echo "\n7. Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð˜ ÐŸÐž ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“Ð£:\n";
echo "==================================\n";
echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð²: {$vk_upload_dir}\n";
echo "2. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ð¸ WordPress\n";
echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· 15-30 Ð¼Ð¸Ð½ÑƒÑ‚\n";
echo "4. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾\n\n";

// 8. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
$monitor_file = $vk_upload_dir . 'monitor_' . date('Ymd_His') . '.log';
$monitor_content = "=== ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“ Ð’Ð«Ð“Ð Ð£Ð—ÐšÐ˜ Ð’ Ð’ÐšÐžÐÐ¢ÐÐšÐ¢Ð• ===\n";
$monitor_content .= "Ð”Ð°Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°: " . date('Y-m-d H:i:s') . "\n";
$monitor_content .= "Ð’ÑÐµÐ³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð‘Ð”: {$total_products}\n";
$monitor_content .= "Ð’Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ñ€Ð°Ð½ÐµÐµ: {$exported_products}\n";
$monitor_content .= "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð²Ñ‹Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ: {$not_exported}\n";
$monitor_content .= "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð¿Ð¾Ð»Ð½Ð°Ñ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ°\n";
$monitor_content .= "=====================================\n\n";

file_put_contents($monitor_file, $monitor_content);
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ„Ð°Ð¹Ð» Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°: " . basename($monitor_file) . "\n";

echo "\n=== Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð ===\n";
echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ‡ÐµÑ€ÐµÐ· 15-30 Ð¼Ð¸Ð½ÑƒÑ‚\n";
?>
