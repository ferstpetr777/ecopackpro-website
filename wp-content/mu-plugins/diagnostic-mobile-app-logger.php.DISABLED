<?php
/**
 * Plugin Name: Diagnostic Mobile App Logger
 * Description: Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ - Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
 * Version: 1.0
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¾Ñ‚ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
 */
add_action( 'init', 'diagnostic_log_mobile_app_request', 1 );
function diagnostic_log_mobile_app_request() {
	$log_file = WP_CONTENT_DIR . '/mobile-app-diagnostic.log';
	
	// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ
	$user_agent = isset( $_SERVER['HTTP_USER_AGENT'] ) ? $_SERVER['HTTP_USER_AGENT'] : 'UNKNOWN';
	$request_uri = isset( $_SERVER['REQUEST_URI'] ) ? $_SERVER['REQUEST_URI'] : 'UNKNOWN';
	$request_method = isset( $_SERVER['REQUEST_METHOD'] ) ? $_SERVER['REQUEST_METHOD'] : 'UNKNOWN';
	$referer = isset( $_SERVER['HTTP_REFERER'] ) ? $_SERVER['HTTP_REFERER'] : 'NONE';
	
	// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð¾ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð½ÐµÑ‚
	$is_mobile_app = false;
	$app_type = 'WEB';
	
	// ÐŸÑ€Ð¸Ð·Ð½Ð°ÐºÐ¸ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
	if ( 
		stripos( $user_agent, 'wv' ) !== false || // WebView
		stripos( $user_agent, 'Mobile' ) !== false ||
		stripos( $user_agent, 'Android' ) !== false ||
		stripos( $user_agent, 'iPhone' ) !== false ||
		stripos( $user_agent, 'iPad' ) !== false
	) {
		$is_mobile_app = true;
		
		if ( stripos( $user_agent, 'wv' ) !== false ) {
			$app_type = 'WEBVIEW';
		} elseif ( stripos( $user_agent, 'Android' ) !== false ) {
			$app_type = 'ANDROID';
		} elseif ( stripos( $user_agent, 'iPhone' ) !== false || stripos( $user_agent, 'iPad' ) !== false ) {
			$app_type = 'iOS';
		}
	}
	
	// Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¾Ñ‚ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
	if ( $is_mobile_app ) {
		// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ WooCommerce
		$cart_count = 0;
		$has_session = false;
		$has_cart_cookie = false;
		
		if ( class_exists( 'WooCommerce' ) && WC()->cart ) {
			$cart_count = WC()->cart->get_cart_contents_count();
			$has_session = WC()->session && WC()->session->get_customer_id() ? true : false;
		}
		
		// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÑƒÐºÐ¸
		if ( isset( $_COOKIE['woocommerce_cart_hash'] ) ) {
			$has_cart_cookie = true;
		}
		
		// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð»Ð¾Ð³
		$log_entry = sprintf(
			"[%s] %s %s\n" .
			"  User-Agent: %s\n" .
			"  App Type: %s\n" .
			"  URI: %s\n" .
			"  Cart Count: %d\n" .
			"  Has Session: %s\n" .
			"  Has Cart Cookie: %s\n" .
			"  Referer: %s\n" .
			"  IP: %s\n" .
			"---\n",
			date( 'Y-m-d H:i:s' ),
			$request_method,
			$is_mobile_app ? 'ðŸ“± MOBILE' : 'ðŸ’» DESKTOP',
			$user_agent,
			$app_type,
			$request_uri,
			$cart_count,
			$has_session ? 'YES' : 'NO',
			$has_cart_cookie ? 'YES' : 'NO',
			$referer,
			$_SERVER['REMOTE_ADDR'] ?? 'UNKNOWN'
		);
		
		// Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð² Ð»Ð¾Ð³
		file_put_contents( $log_file, $log_entry, FILE_APPEND );
	}
}

/**
 * Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ AJAX Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² WooCommerce
 */
add_action( 'wc_ajax_get_refreshed_fragments', 'diagnostic_log_fragments_request', 1 );
function diagnostic_log_fragments_request() {
	$log_file = WP_CONTENT_DIR . '/mobile-app-diagnostic.log';
	
	$user_agent = isset( $_SERVER['HTTP_USER_AGENT'] ) ? $_SERVER['HTTP_USER_AGENT'] : 'UNKNOWN';
	
	$log_entry = sprintf(
		"[%s] ðŸ”„ AJAX: get_refreshed_fragments\n" .
		"  User-Agent: %s\n" .
		"  Cart Count: %d\n" .
		"---\n",
		date( 'Y-m-d H:i:s' ),
		$user_agent,
		WC()->cart ? WC()->cart->get_cart_contents_count() : 0
	);
	
	file_put_contents( $log_file, $log_entry, FILE_APPEND );
}

/**
 * Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ endpoint - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
 */
add_action( 'rest_api_init', 'diagnostic_register_logs_api' );
function diagnostic_register_logs_api() {
	register_rest_route( 'diagnostic/v1', '/mobile-app/logs', array(
		'methods'  => 'GET',
		'callback' => 'diagnostic_get_mobile_logs',
		'permission_callback' => '__return_true'
	));
	
	register_rest_route( 'diagnostic/v1', '/mobile-app/clear-logs', array(
		'methods'  => 'POST',
		'callback' => 'diagnostic_clear_mobile_logs',
		'permission_callback' => '__return_true'
	));
}

/**
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
 */
function diagnostic_get_mobile_logs() {
	$log_file = WP_CONTENT_DIR . '/mobile-app-diagnostic.log';
	
	if ( ! file_exists( $log_file ) ) {
		return new WP_REST_Response( array(
			'status' => 'no_logs',
			'message' => 'Ð›Ð¾Ð³ Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹...',
			'log_file' => $log_file
		), 200 );
	}
	
	// Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 50 ÑÑ‚Ñ€Ð¾Ðº
	$logs = file( $log_file );
	$recent_logs = array_slice( $logs, -200 ); // ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 200 ÑÑ‚Ñ€Ð¾Ðº
	
	return new WP_REST_Response( array(
		'status' => 'success',
		'total_lines' => count( $logs ),
		'recent_logs' => implode( '', $recent_logs ),
		'file_size' => filesize( $log_file ),
		'timestamp' => date( 'Y-m-d H:i:s' )
	), 200 );
}

/**
 * ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸
 */
function diagnostic_clear_mobile_logs() {
	$log_file = WP_CONTENT_DIR . '/mobile-app-diagnostic.log';
	
	file_put_contents( $log_file, '' );
	
	return new WP_REST_Response( array(
		'status' => 'cleared',
		'message' => 'Ð›Ð¾Ð³Ð¸ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹...',
		'timestamp' => date( 'Y-m-d H:i:s' )
	), 200 );
}

/**
 * Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¸Ð½Ð³ endpoint - Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¸Ð½Ð³Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
 */
add_action( 'rest_api_init', 'diagnostic_register_ping_api' );
function diagnostic_register_ping_api() {
	register_rest_route( 'diagnostic/v1', '/mobile-app/ping', array(
		'methods'  => 'GET',
		'callback' => 'diagnostic_mobile_ping',
		'permission_callback' => '__return_true'
	));
}

function diagnostic_mobile_ping() {
	$cart_count = class_exists( 'WooCommerce' ) && WC()->cart ? WC()->cart->get_cart_contents_count() : 0;
	
	return new WP_REST_Response( array(
		'status' => 'pong',
		'message' => 'Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½!',
		'cart_count' => $cart_count,
		'timestamp' => date( 'Y-m-d H:i:s' ),
		'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'UNKNOWN'
	), 200 );
}

