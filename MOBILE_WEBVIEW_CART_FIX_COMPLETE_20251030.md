# üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–ê –ö–û–†–ó–ò–ù–´ –í –ú–û–ë–ò–õ–¨–ù–û–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ò
**–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025, 12:03  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**

---

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
**–ù–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ:**
- –¢–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ: "–í–æ–∑–¥—É—à–Ω–æ –ø—É–∑—ã—Ä—å–∫–æ–≤–∞—è –ø–ª–µ–Ω–∫–∞ –ú–∏–Ω–∏-—Ä–æ–ª–∏–∫–∏" (200 —Ä—É–±)
- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: –∏–∫–æ–Ω–∫–∞ "–ö–æ—Ä–∑–∏–Ω–∞" –µ—Å—Ç—å
- **–ù–û:** –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ (badge) **–ù–ï –û–¢–û–ë–†–ê–ñ–ê–ï–¢–°–Ø** ‚ùå

### –ö–æ–Ω—Ç–µ–∫—Å—Ç:
- –°–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –≤ **–º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ WebView**
- –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

---

## üî¨ –ü–†–û–í–ï–î–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó

### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚úÖ
–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å (—Ç–∞–±bar)
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ badge –Ω–∞ –∏–∫–æ–Ω–∫–µ
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–∫—Ä–∏–ø—Ç `mobile-cart-fix.js` —Ä–∞–±–æ—Ç–∞–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ cart fragments ‚úÖ
–í—ã—è–≤–ª–µ–Ω–æ:
- WooCommerce –∏—Å–ø–æ–ª—å–∑—É–µ—Ç sessionStorage –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω—ã
- Cart fragments –º–æ–≥—É—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö WebView
- –°—Ç–∞—Ä—ã–π —Å–∫—Ä–∏–ø—Ç –ø–æ–ª–∞–≥–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ sessionStorage

### –≠—Ç–∞–ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ CSS/JavaScript ‚úÖ
–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:
- CSS `.w-cart-quantity` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ desktop –≤–µ—Ä—Å–∏–∏
- JavaScript –∏—Å–∫–∞–ª —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/cart/`
- –í WebView –º–æ–≥—É—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ sessionStorage

### –≠—Ç–∞–ø 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω ‚úÖ

**–ù–ê–ô–î–ï–ù–û 5 –ü–†–û–ë–õ–ï–ú:**

1. **–î–æ—á–µ—Ä–Ω—è—è —Ç–µ–º–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞**
   - `Impreza-child` –≤ —Å—Ç–∞—Ç—É—Å–µ `inactive`
   - –§–∞–π–ª—ã –∏–∑ child —Ç–µ–º—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
   - functions.php –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

2. **–°–∫—Ä–∏–ø—Ç –ø–æ–ª–∞–≥–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ sessionStorage**
   - –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö WebView sessionStorage –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
   - –ù–µ—Ç fallback –º–µ—Ç–æ–¥–æ–≤

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ API endpoints**
   - –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é
   - –ù–µ—Ç REST API –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã

4. **–ù–µ—Ç data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ HTML**
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ DOM
   - –ù–µ—Ç `data-cart-count` –Ω–∞ body

5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ cross-platform bridge**
   - –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Android WebView Bridge
   - –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ iOS WKWebView postMessage

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: Mobile WebView Cart Bridge

#### 1. **Must-Use Plugin** ‚úÖ
**–§–∞–π–ª:** `/wp-content/mu-plugins/ecopackpro-mobile-cart-bridge.php`

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript bridge
- –í—ã–≤–æ–¥ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ HTML
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è REST API endpoints
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS headers
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–µ–º—ã
- ‚úÖ –ù–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞

#### 2. **JavaScript Bridge** ‚úÖ
**–§–∞–π–ª:** `/wp-content/mu-plugins/mobile-webview-cart-bridge.js`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üì± Android WebView JavaScript Bridge
- üì± iOS WKWebView postMessage
- üåê –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ window
- üìÑ HTML data-–∞—Ç—Ä–∏–±—É—Ç—ã
- üíæ localStorage/sessionStorage
- üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- üëÄ MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ú–µ—Ç–æ–¥—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ (6 —Å–ø–æ—Å–æ–±–æ–≤):**
1. WooCommerce cart fragments (sessionStorage)
2. –≠–ª–µ–º–µ–Ω—Ç—ã `.w-cart-quantity` –≤ DOM
3. –§–æ—Ä–º–∞ –∫–æ—Ä–∑–∏–Ω—ã `.woocommerce-cart-form`
4. Mini cart widget
5. Data-–∞—Ç—Ä–∏–±—É—Ç `body[data-cart-count]`
6. localStorage

**–ú–µ—Ç–æ–¥—ã –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö (8 –∫–∞–Ω–∞–ª–æ–≤):**
1. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (`window.cartCount`)
2. Data-–∞—Ç—Ä–∏–±—É—Ç—ã body/html
3. localStorage/sessionStorage
4. Android Bridge (`Android.onCartUpdate()`)
5. iOS Bridge (`webkit.messageHandlers.cartUpdate`)
6. CustomEvent (`ecopackpro:cartUpdate`)
7. postMessage (–¥–ª—è iframe)
8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö `.w-cart-quantity`

#### 3. **REST API Endpoints** ‚úÖ

**Endpoint 1:** `/wp-json/ecopackpro/v1/cart/count`
```json
{
  "count": 0,
  "timestamp": 1761832990,
  "session_id": "t_554b..."
}
```

**Endpoint 2:** `/wp-json/ecopackpro/v1/cart/details`
```json
{
  "count": 0,
  "items": [],
  "subtotal": "0 ‚ÇΩ",
  "total": "0 ‚ÇΩ",
  "timestamp": 1761832990
}
```

**CORS:** –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚úÖ

---

## üìä E2E –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: 7/7 PASS ‚úÖ

```
‚úÖ [PASS] functions.php valid
    ‚îî‚îÄ functions.php —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

‚úÖ [PASS] Bridge script valid
    ‚îî‚îÄ Bridge —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (13.60 KB)

‚úÖ [PASS] API cart/count
    ‚îî‚îÄ API —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 0

‚úÖ [PASS] API cart/details
    ‚îî‚îÄ API —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ–≤–∞—Ä–æ–≤: 0, items: 0

‚úÖ [PASS] Bridge script loaded
    ‚îî‚îÄ –°–∫—Ä–∏–ø—Ç bridge –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

‚úÖ [PASS] Data attributes
    ‚îî‚îÄ data-cart-count –∏ initialCartCount –Ω–∞–π–¥–µ–Ω—ã

‚úÖ [PASS] CORS headers
    ‚îî‚îÄ CORS headers —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
```

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** < 1 —Å–µ–∫—É–Ω–¥–∞  
**JSON –æ—Ç—á–µ—Ç:** `mobile_webview_e2e_test_report_20251030_120320.json`

---

## üéØ –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢ –í –ú–û–ë–ò–õ–¨–ù–û–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ò

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Android WebView

```javascript
// 1. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è bridge —Å–∫—Ä–∏–ø—Ç
window.EcopackProCartBridge.init()

// 2. Bridge –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
count = 1 (–∏–∑ WooCommerce fragments)

// 3. –í—ã–∑—ã–≤–∞–µ—Ç Android bridge
Android.onCartUpdate(1)  // ‚Üê –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç!

// 4. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç badge –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
// Kotlin/Java –∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
@JavascriptInterface
fun onCartUpdate(count: Int) {
    runOnUiThread {
        bottomNav.updateCartBadge(count)
    }
}
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: iOS WKWebView

```javascript
// 1-2. –¢–æ –∂–µ —Å–∞–º–æ–µ

// 3. –í—ã–∑—ã–≤–∞–µ—Ç iOS bridge
webkit.messageHandlers.cartUpdate.postMessage({count: 1})

// 4. Swift –∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
func userContentController(_ userContentController: WKUserContentController, 
                          didReceive message: WKScriptMessage) {
    if message.name == "cartUpdate" {
        let count = message.body["count"] as? Int
        updateCartBadge(count)
    }
}
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Fallback —á–µ—Ä–µ–∑ API

```javascript
// –ï—Å–ª–∏ bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API:
fetch('https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count')
    .then(response => response.json())
    .then(data => updateCartBadge(data.count))
```

---

## üì± –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### –î–ª—è Android (Java/Kotlin):

```kotlin
// 1. –î–æ–±–∞–≤–∏—Ç—å JavaScript Interface
webView.addJavascriptInterface(object {
    @JavascriptInterface
    fun onCartUpdate(count: Int) {
        runOnUiThread {
            // –û–±–Ω–æ–≤–∏—Ç—å badge –Ω–∞ TabBar
            bottomNavigationView.getOrCreateBadge(R.id.cart_tab).apply {
                number = count
                isVisible = count > 0
            }
        }
    }
    
    @JavascriptInterface
    fun updateCartCount(count: Int) {
        onCartUpdate(count)
    }
}, "Android")

// 2. –í–∫–ª—é—á–∏—Ç—å JavaScript
webView.settings.javaScriptEnabled = true
webView.settings.domStorageEnabled = true
```

### –î–ª—è iOS (Swift):

```swift
// 1. –î–æ–±–∞–≤–∏—Ç—å message handler
let contentController = WKUserContentController()
contentController.add(self, name: "cartUpdate")

let config = WKWebViewConfiguration()
config.userContentController = contentController

// 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
func userContentController(_ userContentController: WKUserContentController, 
                          didReceive message: WKScriptMessage) {
    if message.name == "cartUpdate",
       let body = message.body as? [String: Any],
       let count = body["count"] as? Int {
        // –û–±–Ω–æ–≤–∏—Ç—å badge
        DispatchQueue.main.async {
            self.tabBarController?.tabBar.items?[4].badgeValue = count > 0 ? "\(count)" : nil
        }
    }
}
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (API polling):

```kotlin
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å API
CoroutineScope(Dispatchers.IO).launch {
    while(true) {
        val response = api.getCartCount()
        withContext(Dispatchers.Main) {
            updateCartBadge(response.count)
        }
        delay(5000) // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    }
}
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ò

### Checklist –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å WebView –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ª–æ–≥–æ–≤:
     ```
     [EcopackPro] Initial cart count set: 0
     === Mobile WebView Cart Bridge Initialized ===
     Environment: {isAndroid: true, hasAndroidBridge: true, ...}
     ```

2. **–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É**
   - ‚úÖ –î–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å—Å—è: `Android.onCartUpdate(1)` –∏–ª–∏ iOS postMessage
   - ‚úÖ Badge –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞ –∏–∫–æ–Ω–∫–µ –∫–æ—Ä–∑–∏–Ω—ã

3. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É**
   - ‚úÖ Badge –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤–∏–¥–∏–º—ã–º
   - ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –æ–±–Ω—É–ª—è—Ç—å—Å—è

4. **–£–¥–∞–ª–∏—Ç–µ —Ç–æ–≤–∞—Ä**
   - ‚úÖ –î–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å—Å—è: `Android.onCartUpdate(0)`
   - ‚úÖ Badge –¥–æ–ª–∂–µ–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï: –î–û vs –ü–û–°–õ–ï

| –ê—Å–ø–µ–∫—Ç | –î–û | –ü–û–°–õ–ï |
|--------|-----|-------|
| **Badge –≤ WebView** | ‚ùå –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è | ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Android** | ‚ùå –ù–µ—Ç | ‚úÖ JavaScript Bridge |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ iOS** | ‚ùå –ù–µ—Ç | ‚úÖ WKWebView postMessage |
| **REST API** | ‚ùå –ù–µ—Ç | ‚úÖ 2 endpoints |
| **Fallback –º–µ—Ç–æ–¥—ã** | ‚ùå 1 —Å–ø–æ—Å–æ–± | ‚úÖ 6 —Å–ø–æ—Å–æ–±–æ–≤ |
| **–ö–∞–Ω–∞–ª—ã –ø–µ—Ä–µ–¥–∞—á–∏** | ‚ùå 1 –∫–∞–Ω–∞–ª | ‚úÖ 8 –∫–∞–Ω–∞–ª–æ–≤ |
| **data-–∞—Ç—Ä–∏–±—É—Ç—ã** | ‚ùå –ù–µ—Ç | ‚úÖ –í body/html |
| **CORS** | ‚ùå –ù–µ—Ç | ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω |
| **–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞** | ‚ùå –¢—Ä–µ–±—É–µ—Ç —Ç–µ–º—É | ‚úÖ mu-plugin (–≤—Å–µ–≥–¥–∞) |

---

## üéØ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ –í –ú–û–ë–ò–õ–¨–ù–û–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: JavaScript Bridge (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**

#### Android:
```kotlin
webView.addJavascriptInterface(CartBridge(), "Android")

class CartBridge {
    @JavascriptInterface
    fun onCartUpdate(count: Int) {
        // –û–±–Ω–æ–≤–∏—Ç—å badge
    }
}
```

#### iOS:
```swift
contentController.add(self, name: "cartUpdate")

// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:
func userContentController(...) {
    // –û–±–Ω–æ–≤–∏—Ç—å badge
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß—Ç–µ–Ω–∏–µ –∏–∑ DOM (–ø—Ä–æ—â–µ)

```javascript
// JavaScript –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
setInterval(() => {
    const count = document.body.getAttribute('data-cart-count');
    updateBadge(parseInt(count) || 0);
}, 1000);
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: REST API (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)

```kotlin
// Kotlin
suspend fun getCartCount(): Int {
    val response = api.get("https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count")
    return response.count
}
```

---

## üìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

### Must-Use Plugin:
```
/wp-content/mu-plugins/ecopackpro-mobile-cart-bridge.php (6.4 KB)
‚îú‚îÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è REST API
‚îú‚îÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript
‚îú‚îÄ –í—ã–≤–æ–¥ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
‚îî‚îÄ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

### JavaScript Bridge:
```
/wp-content/mu-plugins/mobile-webview-cart-bridge.js (13.6 KB)
‚îú‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã (Android/iOS/WebView)
‚îú‚îÄ 6 –º–µ—Ç–æ–¥–æ–≤ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ 8 –∫–∞–Ω–∞–ª–æ–≤ –ø–µ—Ä–µ–¥–∞—á–∏
‚îú‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚îî‚îÄ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```
/test_mobile_webview_cart_e2e.py (e2e —Ç–µ—Å—Ç—ã)
/mobile_webview_e2e_test_report_20251030_120320.json (–æ—Ç—á–µ—Ç)
```

### Backup —Ñ–∞–π–ª—ã:
```
/wp-content/themes/Impreza-child/functions.php
/wp-content/themes/Impreza-child/mobile-webview-cart-bridge.js
/wp-content/themes/Impreza-child/mobile-cart-fix.js.backup-20251030_114358
```

---

## üöÄ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨

### –í –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å WebView** (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ debug —Ä–µ–∂–∏–º–µ)

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:**
   ```javascript
   // –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   console.log(window.EcopackProCartBridge);
   console.log(window.getCartCount());
   console.log(document.body.getAttribute('data-cart-count'));
   ```

3. **–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É**

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–∑–æ–≤ bridge:**
   - Android: –î–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å—Å—è `Android.onCartUpdate(1)`
   - iOS: –î–æ–ª–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è `webkit.messageHandlers.cartUpdate`

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ badge:**
   - –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞ –∏–∫–æ–Ω–∫–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

### –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (—ç–º—É–ª—è—Ü–∏—è):

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://ecopackpro.ru –≤ Chrome
2. F12 ‚Üí Toggle device toolbar (Ctrl+Shift+M)
3. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (iPhone, Pixel –∏ —Ç.–¥.)
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å:
   ```
   === Mobile WebView Cart Bridge Initialized ===
   Environment: {...}
   Cart count: 1 Sources: ['cart_form']
   ‚Üí CustomEvent: ecopackpro:cartUpdate
   ```

---

## üîß API ENDPOINTS DOCUMENTATION

### GET /wp-json/ecopackpro/v1/cart/count

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "count": 1,
  "timestamp": 1761832990,
  "session_id": "t_554b6915972e99f740f761aee42890"
}
```

### GET /wp-json/ecopackpro/v1/cart/details

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—Ä–∑–∏–Ω–µ

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "count": 1,
  "items": [
    {
      "product_id": 7856,
      "name": "–í–æ–∑–¥—É—à–Ω–æ –ø—É–∑—ã—Ä—å–∫–æ–≤–∞—è –ø–ª–µ–Ω–∫–∞ –ú–∏–Ω–∏-—Ä–æ–ª–∏–∫–∏",
      "quantity": 1,
      "price": "200",
      "total": 200
    }
  ],
  "subtotal": "200,00 ‚ÇΩ",
  "total": "200,00 ‚ÇΩ",
  "timestamp": 1761832990
}
```

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´

### E2E –¢–µ—Å—Ç—ã: 7/7 PASS ‚úÖ

| # | –¢–µ—Å—Ç | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|---|------|-----------|
| 1 | functions.php valid | ‚úÖ PASS |
| 2 | Bridge script exists | ‚úÖ PASS |
| 3 | API /cart/count | ‚úÖ PASS |
| 4 | API /cart/details | ‚úÖ PASS |
| 5 | Bridge loaded on page | ‚úÖ PASS |
| 6 | Data attributes | ‚úÖ PASS |
| 7 | CORS headers | ‚úÖ PASS |

### –ú–µ—Ç—Ä–∏–∫–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** | < 1 —Å–µ–∫—É–Ω–¥–∞ |
| **–ú–µ—Ç–æ–¥–æ–≤ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** | 6 |
| **–ö–∞–Ω–∞–ª–æ–≤ –ø–µ—Ä–µ–¥–∞—á–∏** | 8 |
| **API endpoints** | 2 |
| **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** | Android + iOS + Web |
| **Fallback —É—Ä–æ–≤–Ω–µ–π** | 3 —É—Ä–æ–≤–Ω—è |

---

## üí° –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –î–ª—è backend (–í–´–ü–û–õ–ù–ï–ù–û):
- ‚úÖ –°–æ–∑–¥–∞–Ω mu-plugin
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã API endpoints
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã data-–∞—Ç—Ä–∏–±—É—Ç—ã
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã CORS
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

### –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (TODO):

#### Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
1. üìù –î–æ–±–∞–≤–∏—Ç—å JavaScript Interface —Å –º–µ—Ç–æ–¥–∞–º–∏ `onCartUpdate()` –∏ `updateCartCount()`
2. üìù –í–∫–ª—é—á–∏—Ç—å `domStorageEnabled = true` –≤ WebView
3. üìù –û–±–Ω–æ–≤–ª—è—Ç—å badge –ø—Ä–∏ –≤—ã–∑–æ–≤–µ bridge –º–µ—Ç–æ–¥–æ–≤
4. üìù –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ç–æ–≤–∞—Ä–æ–º

#### iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
1. üìù –î–æ–±–∞–≤–∏—Ç—å WKScriptMessageHandler –¥–ª—è "cartUpdate"
2. üìù –û–±—Ä–∞–±–æ—Ç–∞—Ç—å postMessage –≤ Swift –∫–æ–¥–µ
3. üìù –û–±–Ω–æ–≤–ª—è—Ç—å badge –Ω–∞ TabBar
4. üìù –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

## üîç –û–¢–õ–ê–î–ö–ê

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ WebView:

**JavaScript –∫–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:**
```javascript
// –í—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å WebView –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
console.log('Bridge loaded:', typeof window.EcopackProCartBridge !== 'undefined');

// 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
console.log('Cart count:', window.getCartCount());

// 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
window.updateCartNow();

// 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ data-–∞—Ç—Ä–∏–±—É—Ç–∞
console.log('Body data-cart-count:', document.body.getAttribute('data-cart-count'));

// 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
console.log('localStorage:', localStorage.getItem('ecopackpro_cart_count'));

// 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã
console.log('Environment:', window.cartBridgeEnvironment);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API:

```bash
# –¢–µ—Å—Ç API
curl https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count

# –¢–µ—Å—Ç —Å cookies (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å–µ—Å—Å–∏—è)
curl https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count \
  -H "Cookie: wp_woocommerce_session_..."
```

---

## üéâ –ò–¢–û–ì–ò

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
1. ‚úÖ **–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑** –ø—Ä–æ–±–ª–µ–º—ã (4 —ç—Ç–∞–ø–∞)
2. ‚úÖ **–ù–∞–π–¥–µ–Ω–æ 5 –ø—Ä–∏—á–∏–Ω** –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
3. ‚úÖ **–°–æ–∑–¥–∞–Ω–æ —Ä–µ—à–µ–Ω–∏–µ** —Å 3 —É—Ä–æ–≤–Ω—è–º–∏ fallback
4. ‚úÖ **Must-Use Plugin** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã
5. ‚úÖ **JavaScript Bridge** –¥–ª—è WebView
6. ‚úÖ **2 REST API** endpoints
7. ‚úÖ **E2E —Ç–µ—Å—Ç—ã** (7/7 PASS)
8. ‚úÖ **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —Å–∞–π—Ç–∞:
- ‚úÖ Bridge —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- ‚úÖ Data-–∞—Ç—Ä–∏–±—É—Ç—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ HTML
- ‚úÖ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

### –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å:
- üìù **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –≤ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã—à–µ)
- üìù **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**

---

## üìû –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê

### –¢–µ—Å—Ç–æ–≤—ã–µ endpoints:
- `https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count`
- `https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/details`

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ mu-plugin
sudo -u www-data wp eval 'echo function_exists("ecopackpro_api_get_cart_count") ? "OK" : "FAIL";'

# –¢–µ—Å—Ç API
curl https://ecopackpro.ru/wp-json/ecopackpro/v1/cart/count

# –ó–∞–ø—É—Å–∫ e2e —Ç–µ—Å—Ç–æ–≤
python3 /var/www/fastuser/data/www/ecopackpro.ru/test_mobile_webview_cart_e2e.py
```

---

**üéä –°–æ —Å—Ç–æ—Ä–æ–Ω—ã —Å–∞–π—Ç–∞ –≤—Å–µ –≥–æ—Ç–æ–≤–æ! –û—Å—Ç–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –≤ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.**

*–û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω: 30 –æ–∫—Ç—è–±—Ä—è 2025, 12:05*  
*–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é*

