#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ WordPress —Å–∞–π—Ç–∞ EcoPackPro.ru

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/www/fastuser/data/www/ecopackpro.ru/backup_complete_${TIMESTAMP}"
SITE_DIR="/var/www/fastuser/data/www/ecopackpro.ru"

# –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
DB_NAME="m1shqamai2_worp6"
DB_USER="m1shqamai2_worp6"
DB_PASS="9nUQkM*Q2cnvy379"

echo "================================================================================================"
echo "                        üîÑ –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–ù–û–ì–û –ë–≠–ö–ê–ü–ê –°–ê–ô–¢–ê ECOPACKPRO.RU"
echo "================================================================================================"
echo ""
echo "üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞: ${BACKUP_DIR}"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–∞
echo "üìÅ –°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–∞..."
mkdir -p "${BACKUP_DIR}"
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${BACKUP_DIR}"
echo ""

# 1. –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "================================================================================================"
echo "üíæ –®–ê–ì 1: –ë–≠–ö–ê–ü –ë–ê–ó–´ –î–ê–ù–ù–´–•"
echo "================================================================================================"
echo ""

echo "üìä –î–∞–º–ø –ø–æ–ª–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
mysqldump -u "${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" > "${BACKUP_DIR}/database_full_${TIMESTAMP}.sql" 2>&1
if [ $? -eq 0 ]; then
    DB_SIZE=$(du -h "${BACKUP_DIR}/database_full_${TIMESTAMP}.sql" | cut -f1)
    echo "‚úÖ –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω: ${DB_SIZE}"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
fi
echo ""

# 2. –ë—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞
echo "================================================================================================"
echo "üì¶ –®–ê–ì 2: –ë–≠–ö–ê–ü –§–ê–ô–õ–û–í –°–ê–ô–¢–ê"
echo "================================================================================================"
echo ""

echo "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É—é —Ñ–∞–π–ª—ã —Å–∞–π—Ç–∞ (wp-content, wp-config.php, .htaccess)..."

# –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
cd "${SITE_DIR}"
tar -czf "${BACKUP_DIR}/files_wordpress_${TIMESTAMP}.tar.gz" \
    --exclude='backup_*' \
    --exclude='*.tar.gz' \
    --exclude='*.zip' \
    --exclude='cache/*' \
    --exclude='*.log' \
    wp-content/ \
    wp-config.php \
    .htaccess \
    2>&1 | grep -v "Removing leading"

if [ $? -eq 0 ]; then
    FILES_SIZE=$(du -h "${BACKUP_DIR}/files_wordpress_${TIMESTAMP}.tar.gz" | cut -f1)
    echo "‚úÖ –ë—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω: ${FILES_SIZE}"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ —Ñ–∞–π–ª–æ–≤"
fi
echo ""

# 3. –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
echo "================================================================================================"
echo "üìù –®–ê–ì 3: –°–û–ó–î–ê–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ì–û –§–ê–ô–õ–ê"
echo "================================================================================================"
echo ""

cat > "${BACKUP_DIR}/backup_info.txt" << INFOEOF
================================================================================
–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–≠–ö–ê–ü–ï –°–ê–ô–¢–ê ECOPACKPRO.RU
================================================================================

–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: $(date '+%Y-%m-%d %H:%M:%S')
–¢–∏–ø –±—ç–∫–∞–ø–∞: –ü–æ–ª–Ω—ã–π (–ë–î + —Ñ–∞–π–ª—ã)
–°–æ–∑–¥–∞–Ω: SEO Content Management System

================================================================================
–°–û–°–¢–ê–í –ë–≠–ö–ê–ü–ê:
================================================================================

1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
   - –§–∞–π–ª: database_full_${TIMESTAMP}.sql
   - –†–∞–∑–º–µ—Ä: $(du -h "${BACKUP_DIR}/database_full_${TIMESTAMP}.sql" 2>/dev/null | cut -f1)
   - –¢–∞–±–ª–∏—Ü: $(mysql -u "${DB_USER}" -p"${DB_PASS}" -D "${DB_NAME}" -e "SHOW TABLES;" 2>/dev/null | wc -l)
   
2. –§–∞–π–ª—ã WordPress:
   - –§–∞–π–ª: files_wordpress_${TIMESTAMP}.tar.gz
   - –†–∞–∑–º–µ—Ä: $(du -h "${BACKUP_DIR}/files_wordpress_${TIMESTAMP}.tar.gz" 2>/dev/null | cut -f1)
   - –í–∫–ª—é—á–µ–Ω–æ:
     * wp-content/ (—Ç–µ–º—ã, –ø–ª–∞–≥–∏–Ω—ã, –∑–∞–≥—Ä—É–∑–∫–∏)
     * wp-config.php (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
     * .htaccess (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞)

================================================================================
–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–û–ù–¢–ï–ù–¢–ê:
================================================================================

–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π: 50
–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤: $(mysql -u "${DB_USER}" -p"${DB_PASS}" -D "${DB_NAME}" -e "SELECT COUNT(*) FROM wp_posts WHERE post_type='post' AND post_status='publish';" 2>/dev/null | tail -1)
–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: $(mysql -u "${DB_USER}" -p"${DB_PASS}" -D "${DB_NAME}" -e "SELECT COUNT(*) FROM wp_posts WHERE post_type='page' AND post_status='publish';" 2>/dev/null | tail -1)
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: $(find ${SITE_DIR}/wp-content/uploads -type f 2>/dev/null | wc -l)

================================================================================
–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ó –ë–≠–ö–ê–ü–ê:
================================================================================

1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
   mysql -u ${DB_USER} -p${DB_PASS} ${DB_NAME} < database_full_${TIMESTAMP}.sql

2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:
   cd /var/www/fastuser/data/www/ecopackpro.ru
   tar -xzf files_wordpress_${TIMESTAMP}.tar.gz

================================================================================
–í–ê–ñ–ù–û:
================================================================================

- –ü–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à WordPress
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º (chown -R fastuser:fastuser)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞

================================================================================
INFOEOF

echo "‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: backup_info.txt"
echo ""

# 4. –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π –∞—Ä—Ö–∏–≤
echo "================================================================================================"
echo "üóúÔ∏è  –®–ê–ì 4: –°–û–ó–î–ê–ù–ò–ï –û–ë–©–ï–ì–û –ê–†–•–ò–í–ê"
echo "================================================================================================"
echo ""

FINAL_ARCHIVE="${SITE_DIR}/FULL_BACKUP_ECOPACKPRO_${TIMESTAMP}.tar.gz"
echo "üì¶ –°–æ–∑–¥–∞—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤..."

cd "${BACKUP_DIR}/.."
tar -czf "${FINAL_ARCHIVE}" "backup_complete_${TIMESTAMP}/" 2>&1 | grep -v "Removing leading"

if [ $? -eq 0 ]; then
    FINAL_SIZE=$(du -h "${FINAL_ARCHIVE}" | cut -f1)
    echo "‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${FINAL_SIZE}"
    echo "üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${FINAL_ARCHIVE}"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞"
fi
echo ""

# 5. –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "================================================================================================"
echo "üìä –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–≠–ö–ê–ü–ï"
echo "================================================================================================"
echo ""
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞: ${BACKUP_DIR}"
echo "üì¶ –§–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤: ${FINAL_ARCHIVE}"
echo ""
echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—ç–∫–∞–ø–∞:"
ls -lh "${BACKUP_DIR}/" | tail -n +2
echo ""

TOTAL_SIZE=$(du -sh "${BACKUP_DIR}" | cut -f1)
echo "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: ${TOTAL_SIZE}"
echo ""

echo "================================================================================================"
echo "                               ‚úÖ –ë–≠–ö–ê–ü –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!"
echo "================================================================================================"
